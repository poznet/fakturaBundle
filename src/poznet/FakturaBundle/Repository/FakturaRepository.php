<?php

namespace poznet\FakturaBundle\Repository;

use poznet\FakturaBundle\Dql\Month;

/**
 * FakturaRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FakturaRepository extends \Doctrine\ORM\EntityRepository
{

    public function findLastNumberForMonth(\DateTime $data, $firm = null)
    {

        $emConfig = $this->getEntityManager()->getConfiguration();
        $emConfig->addCustomDatetimeFunction('YEAR', 'DoctrineExtensions\Query\Mysql\Year');
        $emConfig->addCustomDatetimeFunction('MONT', 'DoctrineExtensions\Query\Mysql\Month');
        $emConfig->addCustomDatetimeFunction('DAY', 'DoctrineExtensions\Query\Mysql\Day');

        if($firm==0) $firm=null;
        if ($firm != null) {
            $result = $this->getEntityManager()->createQuery('
        SELECT F from FakturaBundle:Faktura F
        WHERE MONTH(F.data_wystawienia)=:miesiac
        AND WHERE F.sprzedawcaId=:firm
        ORDER BY F.id DESC  ')
                ->setParameter('firm', $firm);
        } else {
            $result = $this->getEntityManager()->createQuery('
        SELECT F from FakturaBundle:Faktura F
        WHERE MONTH(F.data_wystawienie)=:miesiac
        ORDER BY F.id DESC 
        ');
        }
        $result
            ->setParameter('miesiac', $data->format('m'))
            ->getFirstResult();

        return $result;
    }

    public function findByMiesiac($rok, $miesiac, $firm = null)
    {


        $result = $this->getEntityManager()->createQuery('
        SELECT F from poznetFakturaBundle:Faktura F
        WHERE MONTH(F.dataWystawienia)=:miesiac
        AND   YEAR(F.dataWystawienia)=:rok
        AND  F.firmaId=:firm
        ORDER BY F.id DESC  ')
            ->setParameter('firm', $firm)
            ->setParameter('miesiac', $miesiac )
        ->setParameter('rok', $rok )->getResult();

        return $result;


    }
}
